function Main(){}function AppInteractionService(e,t,i){this.toolBarHeight=e,this.currentFileId=null,this.currentCommentId=null,this.files=this.getFiles(),this.hotKeysService=t,this.main=i}function DecorationService(e){this.element=e}function HierarchyGeneratorService(){this.cnt=0}function HotKeysService(){this.diffNext=74,this.diffPrev=75,this.commentNext=78,this.commentPrev=80,this.toggleSidebar=90;var e=this;"undefined"!=typeof chrome&&(chrome.storage.local.get("hotkeys",function(t){t.hasOwnProperty("hotkeys")&&e.updateHotkeys(t.hotkeys)}),chrome.storage.onChanged.addListener(function(t,i){t.hasOwnProperty("hotkeys")&&e.updateHotkeys(t.hotkeys.newValue)}))}Main.prototype.init=function(){this.hiddenSidebarUrls=[],this.pageLoadWaitTimeout=1e3,this.initialNumberOfFiles=0,this.hotKeysService=new HotKeysService,this.generateApp(),window==top&&(window.addEventListener("keyup",this.doKeyPress.bind(this),!1),setInterval(this.monitorUrlChange.bind(this),100)),setInterval(this.monitorLazyLoading.bind(this),100)},Main.prototype.generateApp=function(){this.currentPageUrl=this.getWindowLocationHref(),this.toolBarHeight=$(".pr-toolbar").height(),this.initialNumberOfFiles=$(".file").length;var e=[],t=[];$.each($(".file[id^=diff-]"),function(i,r){var o=$(r).find(".file-header[data-path]").data("path");o&&(e[i]=o,t[i]=$(r).attr("id"))});var i=$('<p id="jk-hierarchy"></p>');(new HierarchyGeneratorService).generateAndApplyHierarchyHtml(e,t,i),$("body").prepend(i);var r=new DecorationService(i);r.applyInitStyle(),r.appendCommentCounts(),r.appendNoDiffMessage();var o=new AppInteractionService(this.toolBarHeight,this.hotKeysService,this);o.attachFolderCollapseBehavior(i),o.attachJumpOnClickBehavior(i),o.updateCurentDiffPos(),this.appInteractionService=o},Main.prototype.doKeyPress=function(e){var t=$(e.target).prop("tagName");"BODY"!=t&&void 0!=t||this.hotKeysService.isValidKeyCode(e.keyCode)&&this.appInteractionService.respondToHotKey(e.keyCode)},Main.prototype.monitorUrlChange=function(){this.isSameUrl()||(this.currentPageUrl=this.getWindowLocationHref(),$("#jk-hierarchy").remove())},Main.prototype.isSameUrl=function(){return this.currentPageUrl==this.getWindowLocationHref()},Main.prototype.getWindowLocationHref=function(){return window.location.href.split("#")[0]},Main.prototype.monitorLazyLoading=function(){this.initialNumberOfFiles!=$(".file").length&&($("#jk-hierarchy").remove(),this.generateApp())},AppInteractionService.prototype.attachFolderCollapseBehavior=function(e){$(e).find(".folder").click(function(){$header=$(this),$content=$header.next(),$content.slideToggle(10,function(){$header.toggleClass("collapsed")})})},AppInteractionService.prototype.attachJumpOnClickBehavior=function(e){var t=this;$(e).find(".jk-file").click(function(e){t.scrollTo($("#"+$(this).data("file-id"))),t.currentFileId=$(this).data("file-id").split("-")[1]})},AppInteractionService.prototype.scrollTo=function(e){if($(e).length){var t=$(e).offset().top-this.toolBarHeight-10;$("html,body").scrollTop(t),this.updateCurentDiffPos()}},AppInteractionService.prototype.updateCurentDiffPos=function(){var e=null;if($.each(this.getFiles(),function(t,i){i.getBoundingClientRect().top<139&&(e=$(i).attr("id"))}),$("#jk-hierarchy").find(".jk-file.current").removeClass("current"),$("#jk-hierarchy").find('.jk-file*[data-file-id="'+e+'"]').addClass("current"),$("#jk-hierarchy").is(":visible")&&$("#jk-hierarchy").find(".jk-file.current").is(":visible")){for(;function(){var e=$("#jk-hierarchy").find(".jk-file.current").position();return e&&e.top<0}();)$("#jk-hierarchy").scrollTop($("#jk-hierarchy").scrollTop()-10);for(;function(){var e=$("#jk-hierarchy").find(".jk-file.current").position();return e&&e.top>$("#jk-hierarchy").height()}();)$("#jk-hierarchy").scrollTop($("#jk-hierarchy").scrollTop()+10)}},AppInteractionService.prototype.getFiles=function(){return $(".file[id^=diff-]")},AppInteractionService.prototype.getComments=function(){return $("#files .js-comment.unminimized-comment")},AppInteractionService.prototype.getCurrentEl=function(){return this.getFiles()[this.currentFileId]},AppInteractionService.prototype.updateCurrentPos=function(e){null==this.currentFileId?this.currentFileId=0:this.currentFileId<this.files.length-1&&e==this.hotKeysService.getKeyCodeForNextDiff()?this.currentFileId++:this.currentFileId>0&&e==this.hotKeysService.getKeyCodeForPrevDiff()&&this.currentFileId--},AppInteractionService.prototype.updateCurrentCommentPos=function(e){null==this.currentCommentId?this.currentCommentId=0:this.currentCommentId<this.getComments().length-1&&e==this.hotKeysService.getKeyCodeForNextComment()?this.currentCommentId++:this.currentCommentId>0&&e==this.hotKeysService.getKeyCodeForPrevComment()&&this.currentCommentId--},AppInteractionService.prototype.getCurrentCommentEl=function(){return this.getComments()[this.currentCommentId]},AppInteractionService.prototype.respondToHotKey=function(e){if(this.hotKeysService.isValidKeyCodeForDiff(e)){this.updateCurrentPos(e);var t=this.getCurrentEl();return void this.scrollTo(t)}if(this.hotKeysService.isValidKeyCodeForComment(e)){this.updateCurrentCommentPos(e);var t=this.getCurrentCommentEl();return void this.scrollTo(t)}this.hotKeysService.isValidKeyCodeForSideBarToggle(e)&&(this.isSidebarHaveContents()||($("#jk-hierarchy").remove(),this.main.generateApp()),this.isSidebarHaveContents()?$("#jk-hierarchy").toggle():$("#jk-notice").show().delay(600).fadeOut(600))},AppInteractionService.prototype.isSidebarHaveContents=function(){return $("#jk-hierarchy").length&&$("#jk-hierarchy")[0].innerHTML},DecorationService.prototype.applyInitStyle=function(){$(this.element).css("width",1.2*$(this.element).width()),$(this.element).css("background-color",$("body").css("background-color")),$(this.element).hide()},DecorationService.prototype.appendCommentCounts=function(){var e=$("#jk-hierarchy").find(".jk-file");$.each(e,function(e,t){var i=$(t).data("file-id"),r=$("#"+i).find(".js-comment.unminimized-comment");if(r.length){var o=$('<span class="comment-count"> ('+r.length+")</span>");$(t).append(o)}})},DecorationService.prototype.appendNoDiffMessage=function(){$("#jk-notice").length||($("body").prepend('<div id="jk-notice">No diffs found</div>'),$("#jk-notice").css("background-color",$("body").css("background-color")))},HierarchyGeneratorService.prototype.generateAndApplyHierarchyHtml=function(e,t,i){this.files=e,this.fileIds=t,this.element=i;var r=this.getCompressedHierarchy();this.generateAndApplyHtml(this.element,r)},HierarchyGeneratorService.prototype.getCompressedHierarchy=function(){var e=this.getHierarchyStructure(this.files);return this.compressHierarchy(e)},HierarchyGeneratorService.prototype.getHierarchyStructure=function(e){var t={};for(key in e){var i=e[key].split("/");this.addProp(t,i)}return t},HierarchyGeneratorService.prototype.addProp=function(e,t){if(1==t.length){var i=t.splice(0,1);return void(e[i[0]]=i[0])}if(t.length>1){var r=t.splice(0,1);e.hasOwnProperty(r)||(e[r]={}),this.addProp(e[r],t)}},HierarchyGeneratorService.prototype.compressHierarchy=function(e){function t(e,i,r){for(var o in e)r&&"string"==typeof e[o]||(r=r+String(o)+"/"),"string"!=typeof e[o]?"object"==typeof e[o]&&Object.keys(e[o]).length>1?(i[r]={},t(e[o],i[r],""),r=""):(t(e[o],i,r),r=""):(1==Object.keys(e).length?(i[r]={},i[r][String(o)+"/"]=e[o]):i[r]=e[o],r="")}var i={};return t(e,i,""),i},HierarchyGeneratorService.prototype.generateAndApplyHtml=function(e,t){var i=$(document.createElement("ul")),r=this;$.each(t,function(o,n){var s="string"==typeof n?n:o,c=$("<li>"+s+"</li>");"object"==typeof t[o]?c.addClass("folder"):"string"==typeof t[o]&&(c=$('<li><span class="file-name">'+s+"</span></li>"),c.addClass("jk-file"),c.attr("data-file-id",r.fileIds[r.cnt]),r.cnt=r.cnt+1),i.append(c),e.append(i),"object"==typeof t[o]&&r.generateAndApplyHtml(i,t[o])})},HotKeysService.prototype.updateHotkeys=function(e){this.diffNext=e.diffNext,this.diffPrev=e.diffPrev,this.commentNext=e.commentNext,this.commentPrev=e.commentPrev,this.toggleSidebar=e.toggleSidebar},HotKeysService.prototype.getKeyCodeForNextDiff=function(){return this.diffNext},HotKeysService.prototype.getKeyCodeForPrevDiff=function(){return this.diffPrev},HotKeysService.prototype.getKeyCodeForNextComment=function(){return this.commentNext},HotKeysService.prototype.getKeyCodeForPrevComment=function(){return this.commentPrev},HotKeysService.prototype.getKeyCodeForToggleSidebar=function(){return this.toggleSidebar},HotKeysService.prototype.isValidKeyCodeForDiff=function(e){return e==this.getKeyCodeForNextDiff()||e==this.getKeyCodeForPrevDiff()},HotKeysService.prototype.isValidKeyCodeForComment=function(e){return e==this.getKeyCodeForNextComment()||e==this.getKeyCodeForPrevComment()},HotKeysService.prototype.isValidKeyCodeForSideBarToggle=function(e){return e==this.getKeyCodeForToggleSidebar()},HotKeysService.prototype.isValidKeyCode=function(e){return this.isValidKeyCodeForDiff(e)||this.isValidKeyCodeForComment(e)||this.getKeyCodeForToggleSidebar(e)};